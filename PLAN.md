# План разработки приложения METAR для Windows 10

## Обзор проекта

Приложение на Go для получения, декодирования и отображения погодных данных METAR в системном трее Windows 10 с иконками облачности и осадков, а также сохранением истории изменений.

## Этапы разработки

### Этап 1: Инициализация проекта и базовая структура

**Цель:** Создать основу проекта и настроить зависимости

**Задачи:**

1. Инициализировать Go модуль (`go mod init`)
2. Создать структуру директорий:
   - `cmd/metar-tray/` - точка входа приложения
   - `internal/metar/` - логика получения и декодирования METAR
   - `internal/tray/` - работа с системным треем
   - `internal/storage/` - сохранение истории погоды
   - `internal/config/` - конфигурация приложения
   - `assets/icons/` - иконки для отображения
3. Создать базовые файлы и структуры

**Зависимости:**

- `github.com/getlantern/systray` - для работы с системным треем
- `github.com/go-resty/resty/v2` или стандартный `net/http` - для HTTP запросов
- `github.com/BurntSushi/toml` или `github.com/spf13/viper` - для конфигурации
- `github.com/mattn/go-sqlite3` или `modernc.org/sqlite` - для хранения истории

---

### Этап 2: Получение данных METAR

**Цель:** Реализовать получение METAR данных из внешних источников

**Задачи:**

1. Исследовать доступные API для получения METAR:
   - Aviation Weather Center (AWC)
   - NOAA
   - Open-Meteo (если поддерживает METAR)
   - Другие публичные источники
2. Создать структуру для хранения METAR данных
3. Реализовать HTTP клиент для запросов
4. Добавить обработку ошибок и повторные попытки
5. Реализовать кэширование для снижения нагрузки на API

**Структуры данных:**

```go
type METAR struct {
    Raw         string
    Station     string
    Time        time.Time
    Wind        Wind
    Visibility  Visibility
    Weather     []WeatherCondition
    Clouds      []CloudLayer
    Temperature float64
    DewPoint    float64
    Pressure    float64
}
```

---

### Этап 3: Декодирование METAR

**Цель:** Парсинг и декодирование METAR строки в структурированные данные

**Задачи:**

1. Изучить формат METAR (ICAO стандарт)
2. Реализовать парсер METAR строки:
   - Станция (4-буквенный код ICAO)
   - Дата и время
   - Ветер (направление, скорость, порывы)
   - Видимость
   - Погодные явления (осадки, туман и т.д.)
   - Облачность (высота, тип)
   - Температура и точка росы
   - Давление (QNH/altimeter)
3. Обработка специальных случаев:
   - CAVOK (Clear Air Visibility OK)
   - Нет данных (NIL, //)
   - Автоматические отчеты (AUTO)
   - Корректированные отчеты (COR)
4. Валидация данных

**Возможные библиотеки:**

- Написать собственный парсер (рекомендуется для обучения)
- Или использовать существующие: `github.com/xenon007/go-metar` (если есть)

---

### Этап 4: Работа с системным треем Windows

**Цель:** Создать интерфейс в системном трее

**Задачи:**

1. Настроить `systray` библиотеку
2. Создать иконку приложения (базовая)
3. Реализовать меню трея:
   - Текущая погода (облачность, осадки)
   - История изменений
   - Настройки (ICAO код станции, интервал обновления)
   - Выход
4. Реализовать обновление иконки в зависимости от погоды
5. Добавить tooltip с краткой информацией

**Иконки для отображения:**

- Ясно (Clear)
- Малооблачно (Few clouds)
- Переменная облачность (Scattered)
- Облачно (Broken)
- Пасмурно (Overcast)
- Осадки (Rain, Snow, etc.)
- Комбинированные состояния

---

### Этап 5: Создание иконок погоды

**Цель:** Разработать набор иконок для отображения погодных условий

**Задачи:**

1. Создать/найти иконки для различных состояний:
   - Облачность (5 уровней: Clear, FEW, SCT, BKN, OVC)
   - Осадки (дождь, снег, град, туман)
   - Комбинации (облачность + осадки)
2. Использовать формат ICO или PNG (16x16, 32x32)
3. Встроить иконки в приложение (embed или ресурсы)
4. Реализовать логику выбора иконки на основе декодированных данных

**Приоритеты иконок:**

1. Осадки (если есть - показывать их)
2. Облачность (если нет осадков)
3. Видимость (туман, дымка)

---

### Этап 6: Сохранение истории изменений

**Цель:** Реализовать хранение динамики изменения погоды

**Задачи:**

1. Выбрать метод хранения:
   - SQLite (рекомендуется - легковесная БД)
   - JSON файлы
   - CSV файлы
2. Создать схему БД:
   ```sql
   CREATE TABLE metar_history (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       station TEXT NOT NULL,
       timestamp DATETIME NOT NULL,
       raw_metar TEXT,
       cloud_base INTEGER,
       cloud_type TEXT,
       precipitation TEXT,
       visibility REAL,
       temperature REAL,
       pressure REAL
   );
   CREATE INDEX idx_station_time ON metar_history(station, timestamp);
   ```
3. Реализовать функции сохранения данных
4. Реализовать функции чтения истории
5. Добавить очистку старых данных (например, старше 30 дней)

---

### Этап 7: Конфигурация приложения

**Цель:** Настроить параметры приложения

**Задачи:**

1. Создать файл конфигурации (TOML/YAML/JSON):

   ```toml
   [station]
   icao_code = "UUEE"  # Шереметьево, пример

   [update]
   interval_minutes = 30

   [storage]
   history_days = 30
   db_path = "metar.db"

   [api]
   source = "aviationweather.gov"
   timeout_seconds = 10
   ```

2. Реализовать загрузку конфигурации
3. Добавить значения по умолчанию
4. Реализовать сохранение настроек

---

### Этап 8: Периодическое обновление данных

**Цель:** Автоматическое обновление METAR данных

**Задачи:**

1. Реализовать фоновый процесс обновления:
   - Таймер/тикер для периодических запросов
   - Асинхронное обновление без блокировки UI
2. Обработка ошибок сети
3. Уведомления об ошибках (опционально)
4. Логирование событий

---

### Этап 9: UI для истории и настроек

**Цель:** Расширенный интерфейс для просмотра данных

**Задачи:**

1. Реализовать окно/диалог для истории:
   - Таблица с историей изменений
   - График изменения облачности/осадков
   - Фильтры по дате
2. Окно настроек:
   - Выбор ICAO станции
   - Интервал обновления
   - Настройки отображения
3. Использовать:
   - `github.com/lxn/walk` (Windows native)
   - Или веб-интерфейс (если нужен кроссплатформенный)

---

### Этап 10: Тестирование и оптимизация

**Цель:** Обеспечить стабильность и производительность

**Задачи:**

1. Написать unit-тесты для:
   - Парсера METAR
   - Логики выбора иконок
   - Хранения данных
2. Интеграционное тестирование
3. Тестирование на различных METAR строках
4. Оптимизация:
   - Минимизация использования памяти
   - Оптимизация запросов к БД
   - Кэширование иконок
5. Обработка edge cases

---

### Этап 11: Сборка и распространение

**Цель:** Подготовка к использованию

**Задачи:**

1. Настроить сборку:
   - `go build` с флагами для Windows
   - Встраивание ресурсов (иконки)
   - Минимизация размера бинарника
2. Создать installer (опционально):
   - NSIS
   - WiX Toolset
   - Или простой .bat скрипт
3. Документация:
   - README с инструкциями
   - Список поддерживаемых ICAO кодов
   - Примеры конфигурации

---

## Технический стек

### Основные библиотеки:

- **Go 1.21+** - основной язык
- **github.com/getlantern/systray** - системный трей
- **github.com/mattn/go-sqlite3** или **modernc.org/sqlite** - база данных
- **net/http** (стандартная) - HTTP клиент
- **encoding/json** (стандартная) - работа с JSON API
- **time** (стандартная) - работа со временем

### Опциональные библиотеки:

- **github.com/spf13/viper** - конфигурация
- **github.com/lxn/walk** - Windows GUI (для расширенного UI)
- **github.com/go-resty/resty/v2** - удобный HTTP клиент

---

## Структура проекта (финальная)

```
metar/
├── cmd/
│   └── metar-tray/
│       └── main.go
├── internal/
│   ├── metar/
│   │   ├── parser.go
│   │   ├── decoder.go
│   │   └── client.go
│   ├── tray/
│   │   ├── tray.go
│   │   └── icons.go
│   ├── storage/
│   │   ├── database.go
│   │   └── models.go
│   └── config/
│       └── config.go
├── assets/
│   └── icons/
│       ├── clear.ico
│       ├── few.ico
│       ├── scattered.ico
│       ├── broken.ico
│       ├── overcast.ico
│       ├── rain.ico
│       └── ...
├── go.mod
├── go.sum
├── config.toml
├── README.md
└── PLAN.md
```

---

## Приоритеты разработки

### MVP (Минимально жизнеспособный продукт):

1. ✅ Получение METAR данных
2. ✅ Базовое декодирование (облачность, осадки)
3. ✅ Отображение в трее с иконками
4. ✅ Сохранение истории

### Расширенные функции:

- Графики изменений
- Уведомления о значительных изменениях
- Поддержка нескольких станций
- Экспорт данных

---

## Временные оценки

- **Этап 1-2:** 2-3 часа (инициализация + получение данных)
- **Этап 3:** 4-6 часов (парсинг METAR - самая сложная часть)
- **Этап 4-5:** 3-4 часа (трей + иконки)
- **Этап 6:** 2-3 часа (хранение)
- **Этап 7-8:** 2-3 часа (конфигурация + обновление)
- **Этап 9:** 4-5 часов (расширенный UI)
- **Этап 10-11:** 3-4 часа (тестирование + сборка)

**Итого:** ~20-28 часов разработки

---

## Следующие шаги

1. Начать с Этапа 1 - инициализация проекта
2. Поэтапная реализация согласно плану
3. Тестирование на реальных METAR данных
4. Итеративное улучшение на основе обратной связи
